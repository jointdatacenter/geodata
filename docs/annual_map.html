<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
#map {
  width: 100%;
}
.container {
  width: 100%;
  max-width: none;
  margin: 0 auto;
  padding-top: 0 auto;
}

.region-selector {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin-bottom: 2vh;
  gap: 1vw;
}

.region-button {
  padding: 0.8em 1.2em;
  font-size: 1rem;
  background-color: #0c2444;
  color: white;
  border: none;
  border-radius: 0.3em;
  cursor: pointer;
  transition: background-color 0.3s;
}

.region-button.active {
  background-color: #0c2888;
}

.region-button:hover {
  background-color: #0c2111;
}

.map-container {
  width: 100%;
  padding: 0;
}

.legend-container {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  gap: 2vw;
  padding-top: 1vh;
  margin-bottom: 2vh;
}

.legend-item {
  display: flex;
  align-items: center;
}

.legend-color {
  width: 1.2em;
  height: 1.2em;
  margin-right: 0.5em;
}

.legend-text {
  font-size: 1rem;
  color: black;
}
</style>
</head>
<body>
  <div class="container">
    <div class="region-selector" id="region-selector"></div>

    <div class="legend-container" id="legend-container"></div>

    <div class="map-container">
      <svg id="map" width="100%" height="600"></svg>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <script src="annual_map_data.js"></script>
  <script>
    let currentRegion = "global";

    function initUI() {
      const selectorContainer = document.getElementById("region-selector");
      regionButtons.forEach((btn, i) => {
        const button = document.createElement("button");
        button.className = "region-button" + (i === 0 ? " active" : "");
        button.setAttribute("data-region", btn.id);
        button.textContent = btn.label;
        selectorContainer.appendChild(button);
      });

      const legendContainer = document.getElementById("legend-container");
      legendItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "legend-item";

        const colorBox = document.createElement("div");
        colorBox.className = "legend-color";
        if (item.type === "outline") {
          colorBox.style.backgroundColor = "transparent";
          colorBox.style.border = "2px solid " + item.color;
        } else {
          colorBox.style.backgroundColor = item.color;
        }

        const text = document.createElement("span");
        text.className = "legend-text";
        text.textContent = item.text;

        div.appendChild(colorBox);
        div.appendChild(text);
        legendContainer.appendChild(div);
      });
    }

    const svg = d3.select("#map");
    const mapContainer = d3.select(".map-container");
    const width = mapContainer.node().getBoundingClientRect().width - 20;
    const height = 600;

    svg.attr("width", width).attr("height", height);

    const mapElements = {
      fills: svg.append("g").attr("class", "country-fills"),
      borders: svg.append("g").attr("class", "country-borders-regular"),
      completed: svg.append("g").attr("class", "country-borders-completed")
    };

    function createProjection(regionKey) {
      const region = regions[regionKey];

      if (region.useNaturalEarth) {
        return d3.geoNaturalEarth1()
          .scale(width * 0.16)
          .translate([width / 2, height / 2]);
      } else {
        return d3.geoMercator()
          .scale(region.scale)
          .center([(region.bounds[0][0] + region.bounds[1][0]) / 2,
                   (region.bounds[0][1] + region.bounds[1][1]) / 2])
          .translate([width / 2, height / 2]);
      }
    }

    function clearMap() {
      mapElements.fills.selectAll("*").remove();
      mapElements.borders.selectAll("*").remove();
      mapElements.completed.selectAll("*").remove();
      svg.selectAll(".tooltip").remove();
    }

    function renderMap(data, projection, path) {
      mapElements.fills.selectAll("path")
        .data(data.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", d => {
          if (countryCategories.started_prvs_year.includes(d.id)) return COLORS.started_prvs_year;
          if (countryCategories.started_before.includes(d.id)) return COLORS.started_before;
          return COLORS.default;
        })
        .on("mouseover", function(event, d) {
          const [mouseX, mouseY] = d3.pointer(event);
          const tooltipGroup = svg.append("g").attr("class", "tooltip");

          const textElement = tooltipGroup.append("text")
            .attr("x", mouseX + 10)
            .attr("y", mouseY + 16)
            .attr("fill", COLORS.tooltipText)
            .style("font-size", "14px")
            .text(d.properties.name);

          const bbox = textElement.node().getBBox();

          tooltipGroup.insert("rect", "text")
            .attr("x", bbox.x - 5)
            .attr("y", bbox.y - 3)
            .attr("width", bbox.width + 10)
            .attr("height", bbox.height + 6)
            .attr("fill", COLORS.tooltipBg)
            .attr("stroke", COLORS.tooltipBorder)
            .attr("rx", 4)
            .attr("ry", 4);
        })
        .on("mousemove", function(event) {
          const [mouseX, mouseY] = d3.pointer(event);

          const tooltip = svg.select(".tooltip");
          const text = tooltip.select("text");
          const rect = tooltip.select("rect");

          text.attr("x", mouseX + 10).attr("y", mouseY + 16);

          const bbox = text.node().getBBox();
          rect.attr("x", bbox.x - 5)
            .attr("y", bbox.y - 3)
            .attr("width", bbox.width + 10)
            .attr("height", bbox.height + 6);
        })
        .on("mouseout", function() {
          svg.select(".tooltip").remove();
        });

      mapElements.borders.selectAll("path")
        .data(data.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", COLORS.stroke)
        .attr("stroke-width", 1);

      mapElements.completed.selectAll("path")
        .data(data.features.filter(d => countryCategories.completed.includes(d.id)))
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", COLORS.completedOutline)
        .attr("stroke-width", 1);
    }

    initUI();

    d3.json("https://jointdatacenter.github.io/geodata/world.geojson")
      .then(function(data) {
        data.features = data.features.filter(d => d.properties.name !== "Antarctica");

        let projection = createProjection(currentRegion);
        let path = d3.geoPath().projection(projection);

        renderMap(data, projection, path);

        d3.selectAll(".region-button").on("click", function() {
          const newRegion = this.getAttribute("data-region");

          if (newRegion !== currentRegion) {
            d3.selectAll(".region-button").classed("active", false);
            d3.select(this).classed("active", true);

            currentRegion = newRegion;

            projection = createProjection(currentRegion);
            path = d3.geoPath().projection(projection);

            clearMap();
            renderMap(data, projection, path);
          }
        });
      })
      .catch(error => {
        console.error("Error loading or processing the GeoJSON data:", error);
      });
  </script>
</body>
</html>
